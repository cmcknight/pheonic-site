<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/styles.css" type="text/css"/>
    
    <link rel="canonical" href="https://pheonic/blog/2021/eleventy-paging-filtered-collections/" />
    <title>Eleventy: Paging Filtered Collections</title>
</head>
<body>



<div class="site-container">
    <div class="container">
        <nav>
    <div class="logo">
        <a href="/"><img src="/img/pheonic-logo2.png"></a>
    </div>
    <div class="menu">
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/blog/">Blog</a></li>
            <li><a href="/topics/">Topics</a>
            <li><a href="/about/">About</a></li>
        </ul>
    </div>
</nav>

        
<div class="breadcrumbs">
    
    
    
        <a href="/">Home</a> &raquo;
    
    
    
        <a href="/blog/">Blog</a> &raquo;
    
    
    
        <span class="current">Eleventy: Paging Filtered Collections</span>
    
    
</div>
<div class="bottom-line"></div>



        
            <div class="blog-article-container">
    <article>
        <div class="article-header">
            <h1>Eleventy: Paging Filtered Collections</h1>
            <time datetime="2021-01-22T00:00:00.000Z">January 22, 2021</time>
        </div>
        <div class="post-content">
            <p>I have mentioned in the past that I am using <a href="https://11ty.dev">Eleventy</a> for this blog and to build a site for a non-profit organization, <a href="https://farmerfrog.org">Farmer Frog</a>, that distributes food donations to 1.5+ million people across the Pacific Northwest. The blog is sort of my sandbox for testing things before I incorporate them into the Farmer Frog site. Farmer Frog had a blog at one point that was dropped because it was not getting many views. However there are some interesting articles on the blog so I have resuscitated it as part of the move from Wordpress to Eleventy.</p>
<p>Everything was sailing right along until the time came to create custom collections of articles associated with an author. On a single-author blog, this wouldn't be an issue, but there are several authors on the Farmer Frog blog so I needed a way to create a collection of posts for each author. My initial take was to try to create a custom collection:</p>
<br>
<div>
  <pre>
    eleventyConfig.addCollection('authorPosts', function(collectionApi) {
        let myColl = [];
        let posts = collectionApi.getFilteredByTag('posts');
<pre><code>    // build array of author post objects
    posts.forEach(post =&gt; {
        if (myColl.length == 0) {
            // add new author object
            const authObj = { author: post.data.author, posts: [post]};
            myColl.push(authObj);
        } else {
            let obj = myColl.find(x =&gt; x.author === post.data.author);
            if (obj === undefined) {
                // add new author object
                const authObj = { author: post.data.author, posts: [post]};
                myColl.push(authObj);
                } else {
                // push item onto object's posts array
                obj.posts.push(post);
            }
        }
    });

    // console.log(myColl);
    return myColl;
});
</code></pre>
  </pre>
</div>
<br> 
<p>Which creates a dictionary<sup id="fnote1"><a href="#fn1">1</a></sup> of author objects that contains an array of the posts by the author (see below):</p>
<br>
<div>
  <pre>
    {author: "author name":, posts: [{post1}, {post2}, ...]}
  </pre>
</div>
<br>
<p>However, in practice this broke pagination and I didn't want to have to reinvent the wheel for that so then I looked at just filtering the posts on the spot by using a filter:</p>
<br>
<div>
  <pre>
    eleventyConfig.addFilter("byAuthor", function(posts, author) {
        return posts.filter(post => post.data.author === author);
    });
  </pre>
</div>
<br>
<p>This created a different type of pagination breakage where I'd only get the first article on each page and if I set the size to 1 the whole thing would throw an error.</p>
<p>Annoying to say the least.</p>
<p>So after spending a few hours Googling, I went back to the docs thinking that this could <strong>NOT</strong> be a new problem (I was right) and found the <strong>before:</strong> parameter for the pagination object. This parameter allows you to use a callback method to do any sort of data munging that you need to do on a collection <em>before</em> the template begins its processing to generate the HTML page.</p>
<p>Huzzah! I thought and dropped in the code from my filter (good programmers never rewrite anything they don't have to) and...</p>
<p>Eleventy threw an error...</p>
<p>Why? Because Nunjucks apparently won't let you do that. Grrrrr.....</p>
<p>So I wound up rewriting the frontmatter from this:</p>
<br>
<div>
  <pre>
<pre><code>---
title: &quot;Blog&quot;
permalink: &quot;/authors/john-doe/{% if pagination.pageNumber &gt; 0 %}{% pagination.pageNumber | plus: 1 %}{% endif %}/index.html&quot;
layout: &quot;author-posts.njk&quot;
author: &quot;John Doe&quot;
breadcrumbs: 
  - label: &quot;Home&quot;
    url: &quot;/&quot;
  - label: &quot;Blog&quot;
    url: &quot;/blog/&quot;
  - label: &quot;John Doe&quot;
pagination: {
  data: &quot;collections.posts&quot;,
  size: 4,
  reverse: true,
  alias: &quot;posts&quot;,
  before: function(data) { return data.filter(x =&gt; x.data.author === &quot;John Doe&quot; )}
}
---
</code></pre>
  </pre>
</div>
<br>
<p>to this:</p>
<br>
  <pre>
    
    ---js
    {
      title: "Blog",
      permalink: "/authors/john-doe/{% if pagination.pageNumber > 0 %}{% pagination.pageNumber | plus: 1 %}{% endif %}/index.html"
      layout: "author-posts.njk",
      author: "John Doe",
      breadcrumbs: [ 
        {label: "Home", url: "/"}, 
        {label: "Blog", url: "/blog/"}, 
        {label: "John Doe"}],
      pagination: {
        data: "collections.posts",
        size: 4,
        reverse: true,
        alias: "posts",
        before: function(data) { 
          return data.filter(x => x.data.author === "John Doe" )
          };
      }
    }
    ---
    
</pre>
<br>
<p>I also modified the template from this:</p>
<br>
  <pre class="center-text">
    {% for post in posts | byAuthor( author) %}
  </pre>
<br>
<p>to this:</p>
<br>
  <pre class="center-text">
    {% for post in posts %}
  </pre>
<br>
<p>Finally! It works as expected. To be honest, I was half-expecting that it might require a plugin or that I'd have to write something specific because 11ty is still relatively young and is under constant development so finding the <strong>before:</strong> property made my task much simpler.</p>
<br>
<hr style="width: 20rem;">
<sup id="fn1">1</sup>A dictionary is the same thing as a Javascript object.<a href="#fnote1">&larrhk;</a>
        </div>
    </article>
</div>
        

        <footer>
        <p>Copyright &copy; 2020  Pheonic</p>
        </footer>
    </div>
</div>

    <script src="/js/scripts.js"></script>
    

</body>
</html>
